#!/bin/python3

import i3ipc
import os
import sys
import json
import re
import time
import datetime
import threading
import socket

port = 9877

background = '#ff000000'
foreground = '#ffffff'

default_items = "start workspaces | clock | systray donno lang pray weather temperature wifi battery power"

def primary():
    x = os.popen("xrandr -q").read()
    m = re.search(r"connected primary \d+x\d+(\+\d+\+\d+) ", x)
    return m.group(1)

# example: WM(lambda wm: print(wm.json())).run()
class WM:
    def __init__(self, callback):
        try:
            self.i3 = i3ipc.Connection()
            self.title = self.i3.get_tree().find_focused().name
            self.workspaces = self.i3.get_workspaces()
        except:
            print("i3 is not connected")
            self.title = ""
            self.workspaces = {}
            pass
        self.callback = callback

    def on_title_change(self, caller, e):
        self.title = e.container.name
        self.callback(self)

    def on_workspace_change(self, caller, e):
        self.workspaces = self.i3.get_workspaces()
        self.callback(self)

    def run(self):
        if self.i3 is None:
            return
        self.i3.on('workspace::focus', self.on_workspace_change)
        self.i3.on('window::title',    self.on_title_change)
        self.i3.on('window::focus',    self.on_title_change)
        self.i3.on('window::urgent',   self.on_workspace_change)
        #self.i3.on('ipc-shutdown',     lambda e: print("bye"))

        self.i3.main()

    def json(self):
        workspaces = {}
        for w in self.workspaces:
            workspaces[w.name] = {
                "visible": w.visible,
                "focused": w.focused,
                "urgent":  w.urgent
            }
        return json.dumps({
            "title": self.title,
            "workspaces": workspaces
        })

    def lemon(self):
        out = ""
        for w in self.workspaces:
            if w.focused:
                out += "%{F#000000 B#ffffff}"
            elif w.visible:
                out += "%{F#ffffff B#333333}"
            elif w.urgent:
                out += "%{F#ffffff B#900000}"
            else:
                out += "%{F#ffffff B-}"
            onclick = f"i3-msg workspace '{w.name}' >/dev/null"
            out += f"%{{A:{onclick}:}} "
            out += w.name
            #.encode(encoding="ascii",errors="backslashreplace").decode()
            out += " %{A}"
        out += "%{F- B-}" # reset the colors
        return out

class Bar:
    def __init__(self, use_ascii=False, items=None):
        self.server = None
        self.a = use_ascii
        self.wm = WM(self.run_wm_items)

        if items is None:
            self.items_str = default_items
        else:
            self.items_str = items

        places = re.split(r"\s*\|\s*", self.items_str)

        self.items_map = {"l": [], "c": [], "r": []}
        for i in range(len(places)):
            place = [getattr(self, m)
                     for m in re.split(r"\s+", places[i]) if m]
            if i == 0:
                self.items_map["l"] += place
            elif i == 1:
                self.items_map["c"] += place
            else:
                self.items_map["r"] += place

        self.items = self.items_map["l"] + \
            self.items_map["c"] + \
            self.items_map["r"]

        self.last = {}
        self.running = False

    def workspaces(self, arg=None):
        if arg == "period":
            return 0

        return self.wm.lemon()

    def program(self, arg=None):
        if arg == "period":
            return 0

        # TODO: title is not cleared when there is no focused window
        title = self.wm.title
        if len(title) > 40:
            title = title[:40] + "..."

        if self.a:
            return title
        else:
            out = ""
            if title:
                out += "%{A:i3-msg kill >/dev/null:}%{A} "
            out += title
            return out

    def clock(self, arg=None):
        if arg == "period":
            return 1

        t = datetime.datetime.now().strftime("%a %Y.%m.%d %I:%M:%S %p")
        if self.a:
            return t
        else:
            cmd = "theterm -a '-c __floatme__ -g 70x35' 'cal -y && read -p \"\"'"
            return f"%{{A:{cmd}&:}}{t}%{{A}}"

    def battery(self, arg=None):
        if arg == "period":
            return 3

        acpi = os.popen("acpi -b").read().strip()
        percent = int(acpi.split(", ")[1].replace("%", ""))
        charging = "Discharging" not in acpi

        if self.a:
            charging = "~" if charging else ""
            return f"{charging}{percent}%"
        else:
            out = ""
            r = "-"

            if charging:
                r = '#FFFFFF' if percent >= 99 else '#FFD700'
                out += f"%{{F{r}}} "
            elif percent <= 20:
                r = '#FF0000'
                out += f"%{{F{r}}}"
                if percent <= 15:
                    out += " "

            if percent < 50:
                out += ""
            elif percent < 60:
                out += ""
            elif percent < 90:
                out += ""
            else:
                out += ""

            out += f"%{{F-}} {percent}%"
            cmd = "theterm -a '-c __floatme__ -g 75x3' 'watch -tn 1 acpi -i'"
            out = f"%{{A:{cmd}:}}{out}%{{A}}"

            def notif(msg):
                os.system(f"dunstify -u critical -r 12345 '{msg}'")

            if not charging:
                if percent <= 5:
                    notif("SHUTTING DOWN!")
                    os.system("systemctl poweroff")
                elif percent <= 7:
                    notif(f"VERY LOW BATTERY {percent}% WILL SHUTDOWN AT 5%!!!")
                elif percent < 10:
                    notif(f"LOW BATTERY {percent}%")

            return out

    def wifi(self, arg=None):
        if arg == "period":
            return 5

        try:
            with open("/proc/net/wireless") as f:
                v = re.split(r"\s+", f.read().split("\n")[2])[2]
                v = int(float(v))

                if self.a:
                    return f"{v}%"
                else:
                    return f"%{{A:networkmanager_dmenu&:}} {v}%%{{A}}"
        except:
            pass

        return None

    def lang(self, arg=None):
        if arg == "period":
            return 0

        out = os.popen("lang").read().strip()
        if self.a:
            return out
        else:
            return f"%{{A:lang tog:}}{out}%{{A}}"

    def pray(self, arg=None):
        if arg == "period":
            return 30

        out = os.popen("theprayer n 2>/dev/null").read().strip()
        if not out:
            return None

        if self.a:
            return out
        else:
            cmd = "theterm -a '-c __floatme__ -g 25x8' 'theprayer && read -p \"\"'"
            return f"%{{A:{cmd}&:}}  {out}%{{A}}"

    def weather(self, arg=None):
        if arg == "period":
            return 30 * 60

        f = os.getenv("HOME") + "/.cache/weatherreport"
        with open(f) as f:
            out = f.read().split("\n")[3] # third line
            # remove colors https://stackoverflow.com/a/14693789/3825872
            r = re.compile(r'\x1B(?:[@-Z\\-_]|\[[0-?]*[ -/]*[@-~])')
            out = r.sub("", out).strip()
            s = re.search(".+[ \.](\d+) °C", out) # extract the temperature
            try:
                out = s.group(1) + "°C"
            except:
                return None

            if self.a:
                return out
            else:
                cmd = "theterm -a '-c __floatme__ -g 63x38' 'weather-update & head -n 37 ~/.cache/weatherreport && read -p \"\"'"
                return f"%{{A:{cmd}&:}}  {out}%{{A}}"

        return None

    def temperature(self, arg=None):
        if arg == "period":
            return 5

        o = json.loads(os.popen(f"sensors coretemp-isa-0000 -j").read()) \
            ["coretemp-isa-0000"]["Package id 0"]
        t = float(o["temp1_input"])
        m = float(o["temp1_max"])

        if self.a:
            return f"{int(t)}°C"
        else:
            percent = int((t / m) * 100)
            if percent < 70:
                return None
            out = ""
            if percent > 90:
                out += "%{F#FF0000} "
            elif percent > 50:
                out += ""
            elif percent > 40:
                out += ""
            else:
                out += ""
            out += f"%{{F-}} {int(t)}°C"
            cmd = "theterm -a '-c __floatme__ -g 65x19' 'watch -tn 1 sensors'"
            return f"%{{A:{cmd}&:}}{out}%{{A}}"

    def start(self, arg=None):
        if arg == "period":
            return 0

        return "%{A:dmenulauncher&:} START%{A}"

    def close(self, arg=None):
        if arg == "period":
            return 0

        return "%{A:i3-msg kill >/dev/null:}%{A}"

    def power(self, arg=None):
        if arg == "period":
            return 0

        return "%{A:dmenupower:}%{A}"

    def systray(self, arg=None):
        if arg == "period":
            return 0

        return "%{A:toggle-systray&:}%{A}"

    def donno(self, arg=None):
        if arg == "period":
            return 0

        return "%{A:theterm 'lolcowforune -p'&:}¯\_(ツ)_/¯%{A}"

    def host(self, arg=None):
        if arg == "period":
            return 0

        return os.uname()[1]

    def render(self):
        out = ""

        if self.a:
            items_out = []
            for item in self.items:
                content = self.last[item.__name__]
                if not content: continue
                items_out.append(content)
            out += " | ".join(items_out)
        else:
            for place in self.items_map:
                out += f"%{{{place}}}"
                items_out = []
                for item in self.items_map[place]:
                    content = self.last[item.__name__]
                    if not content: continue
                    items_out.append(content)
                out += "  ".join(items_out)
            out += " "

        print(out)
        sys.stdout.flush()

    def run_and_sleep(self, item):
        if item not in self.items:
            return

        while self.running:
            self.last[item.__name__] = item()
            self.render()
            #print(f">>>>> CALLED {item.__name__}, sleeping {item('period')}\n")
            period = item("period")
            if period <= 0:
                break
            time.sleep(period)

    def run_wm_items(self, wm):
        self.run_and_sleep(self.workspaces)
        self.run_and_sleep(self.program)

    def init(self):
        for item in self.items:
            self.last[item.__name__] = item()

    def run(self):
        self.running = True
        self.init()
        self.render()
        threading.Thread(target=self.wm.run).start()
        for item in self.items:
            if item("period") > 0:
                # periodic items run on their own thread
                threading.Thread(target=lambda: self.run_and_sleep(item)).start()

        # start server
        self.server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.server.bind(('', port))
        self.server.listen(1)
        while self.running:
            conn, addr = self.server.accept()
            #print(f"Connection address: {addr}")
            # recieving data
            data = b""
            while True:
                tmp = conn.recv(1024)
                data += tmp
                if not tmp: break
            data = data.decode().split("?")
            cmd = data[0]
            data = data[1]
            if cmd == "update":
                item = getattr(self, data)
                self.last[item.__name__] = item()
                self.render()
        self.server.close()

def lemonbar():
    bin = os.path.abspath(__file__)

    geometry = primary()
    if geometry:
        geometry = f"-g {geometry}"

    fonts = ["Iosevka Fixed",
             "Source Han Sans CN",
             "Font Awesome 5 Free Solid"]
    awesome_size = 19

    tmp = ""
    for f in fonts:
        if "Awesome" in f:
            f += f":pixelsize={awesome_size}"
        tmp += f"-f '{f}' "
    fonts = tmp

    os.system(f"""python3 '{bin}' -p |
    lemonbar {geometry} -p {fonts} -B '{background}' -F '{foreground}' -a 30 | sh""")

if __name__ == "__main__":
    args = sys.argv

    if len(args) >= 2 and args[1] == "lemon":
        lemonbar()
    elif len(args) >= 3 and args[1] == "update":
        item = args[2].encode()
        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        s.connect(("127.0.0.1", port))
        s.send(b"update?" + item)
        s.close()
    else:
        a = False
        p = False
        items = None

        if len(args) >= 2 and args[1] == "-a":
            a = True
            del args[1]

        if len(args) >= 2 and args[1] == "-p":
            p = True
            del args[1]

        if len(args) >= 2 and args[1]:
            items = args[1]

        b = Bar(use_ascii=a, items=items)
        if p:
            b.run()
        else:
            b.init()
            b.render()
