#!/bin/sh

preset() {
    # TODO: automate
    sum="$1"
    case "$sum" in
        'b27529ae25bc5931fcc0ff0f9fc2b9b8')
            echo 'preset: home desk dock'
            xrandr --output LVDS1    --off \
                   --output VIRTUAL1 --off \
                   --output VGA1     --off \
                   --output DP1      --off \
                   --output DP2      --off \
                   --output DP3      --off \
                   --output HDMI1    --off \
                   --output HDMI2    --off \
                   --output HDMI3    --off
            xrandr --output DP3   --mode 1600x900 --pos 0x0    --rotate normal
            xrandr --output VGA1  --mode 1366x768 --pos 1600x0 --rotate left
            ;;

        *)
            return 1
    esac
}

sum() {
    xrandr --verbose   |
        grep -A 8 EDID |
        md5sum         |
        cut -d ' ' -f1
}

handle() {
    [ -n "$mode" ] || mode=extend

    randr=$(xrandr --verbose)
    sum=$(sum)
    echo "SUM = $sum"

    preset "$sum" && return

    primary=$(echo "$randr" |
                  awk '/^[A-Za-z0-9\-]+ connected/ {print echo $1}' |
                  head -n1)
    outputs=$(echo "$randr" |
                  awk '/^[A-Za-z0-9\-]+ (dis)?connected/ {print echo $1" "$2}' |
                  grep -v "$primary")

    cmd="xrandr --output $primary --auto"
    prev="$primary"

    IFS='
'
    for out in $outputs; do
        con=$(echo "$out" | cut -d ' ' -f2)
        out=$(echo "$out" | cut -d ' ' -f1)

        if [ "$con" = connected ]; then
            case "$mode" in
                extend)
                    cmd="$cmd --output $out --auto --right-of $prev" ;;

                mirror)
                    # TODO: scale
                    cmd="$cmd --output $out --auto --pos 0x0" ;;

                *)
                    cmd="$cmd --output $out --off" ;;
            esac
            prev="$out"
        else
            cmd="$cmd --output $out --off"
        fi
    done

    echo "$cmd"
    eval "$cmd"
}

post() {
    # TODO: cleanup
    setwallpaper
    setup-xinput
    command -v bar >/dev/null && {
        killall lemonbar 2>/dev/null
        bar lemon
    } >/dev/null 2>/dev/null &
}

run() {
    mode="$1"
    [ "$2" = --now ] && {
        handle "$mode"
        post
        return
    }
    udevadm monitor | while read -r line; do
        if echo "$line" | grep -Eq 'UDEV.+\(drm\)'; then
            date
            echo "$line"
            handle "$mode"
            post
            echo
        fi
    done
}

main() {
    if [ "$1" = sum ]; then
        sum
    elif [ "$1" = '-q' ]; then
        shift
        run "$@" >/dev/null 2>/dev/null
    else
        run "$@"
    fi
}

main "$@"
