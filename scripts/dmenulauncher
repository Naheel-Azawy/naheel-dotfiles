#!/bin/sh

DMENU="menu-interface -i"
DMENUL="$DMENU -l 20"

[ "$1" = '-c' ] && {
    dmenulauncherpy --clear
    exit
}

RUN=$(dmenulauncherpy | $DMENU)
[ ! "$RUN" ] && exit 1

clean() {
    RUN=$(echo "$RUN" | sed -e 's/^!.\s*//')
}

term() {
    exec theterm "$RUN; fish"
}

calculate() {
    exec theterm "calc \"$RUN\"; calc"
}

duck() {
    RUN=$(echo "$RUN" | url-encode)
    exec "$BROWSER" "https://duckduckgo.com/?q=$RUN&t=ffab&atb=v1-1"
}

findfile() {
    L=$(locate "$RUN")
    [ ! "$L" ] && {
        notify-send "'$RUN' not found!"
        return
    }
    F=$(echo "$L" | eval "$DMENUL")
    N=$(basename "$F")
    case $(printf 'Open\nOpen directory' |
               eval "$DMENU -p 'Open $N?'") in
        'Open')
            exec open "$F"
            ;;
        'Open directory')
            D=$(dirname "$F")
            exec dmenuopendir "$D"
            ;;
    esac
}

# needed to update the database of locate
sudo updatedb &

case $RUN in
    \!t*) clean; term;;
    \!c*) clean; calculate;;
    \!d*) clean; duck;;
    \!f*) clean; findfile;;
    \!s*) clean; theterm "sudo $RUN";;
    *)
        # updating the history
        # - bangs are not saved
        dmenulauncherpy --inc "$RUN"
        if istuiapp "$RUN"; then
            exec theterm "$RUN"
        else
            exec "$RUN"
        fi;;
esac
